<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas 3.0 - Logistics Scanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCwoFkcvIQqR_0ePlOv2mkehHc9zdR8Ljs",
            authDomain: "atlasseq.firebaseapp.com",
            projectId: "atlasseq",
            storageBucket: "atlasseq.firebasestorage.app",
            messagingSenderId: "407494251455",
            appId: "1:407494251455:web:f80d7c25a632764fc3470a"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make available globally
        window.firebaseApp = app;
        window.firebaseDb = db;
    </script>
</head>
<body>
    
    <div class="main-wrapper">
        <div class="container">
            
            <!-- Polygon Upload Section -->
            <section class="card fade-in" id="polygon-section">
                <div class="card-header">
                    <div class="step-indicator">00</div>
                    <div class="header-text">
                        <h2>Upload Route Polygons (Optional)</h2>
                        <p class="info-text">Upload custom route polygon JSON to override default routes.</p>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="upload-area small-upload">
                        <input type="file" id="polygon-upload" accept=".json" style="display: none;">
                        <button id="polygon-upload-btn" class="btn btn-secondary">Upload Polygon JSON</button>
                        <span id="polygon-file-name" class="file-label">No file selected</span>
                    </div>
                    <div id="polygon-status" class="polygon-status"></div>
                    
                    <!-- DSP Detection Results -->
                    <div id="dsp-detection-section" style="display: none;">
                        <div class="detection-panel">
                            <div class="panel-header">
                                <h3>Detected DSPs & Routes</h3>
                            </div>
                            
                            <div id="dsp-detection-results" class="dsp-detection-grid"></div>
                            
                            <div class="detection-actions">
                                <button id="confirm-polygons-btn" class="btn btn-success">✓ Confirm & Use These Routes</button>
                                <button id="report-polygon-error-btn" class="btn btn-outline-danger">⚠ Report Error/Missing DSP</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="card fade-in" id="report-section">
                <div class="card-header">
                    <div class="step-indicator">01</div>
                    <div class="header-text">
                        <h2>Upload Manifest</h2>
                        <p class="info-text">Upload the <code>report.csv</code> containing tracking IDs and coords.</p>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="upload-area">
                        <div class="upload-icon">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                        </div>
                        <input type="file" id="report-upload" accept=".csv" style="display: none;">
                        <div class="upload-controls">
                            <button id="report-upload-btn" class="btn btn-primary btn-lg">Select Report CSV</button>
                            <span id="report-file-name" class="file-label">No file selected</span>
                        </div>
                    </div>
                    <div id="report-status" class="report-status"></div>
                </div>
            </section>

            <section class="card fade-in" id="scanning-section" style="display: none;">
                <div class="card-header">
                    <div class="step-indicator active">02</div>
                    <div class="header-text">
                        <h2>Package Scanning</h2>
                        <p class="info-text">Scan packages to verify DSP assignment and sequence.</p>
                    </div>
                    <div id="sync-status" class="sync-status" title="Real-time sync active">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                        </svg>
                        <span>Live Sync</span>
                    </div>
                </div>

                <div class="card-body">
                    <div class="scan-controls-wrapper">
                        <div class="scan-input-group">
                            <div class="input-icon-wrapper">
                                <svg class="input-icon" viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                                    <path d="M3 3h18v18H3zM7 7h10M7 12h10M7 17h10"/>
                                </svg>
                                <input 
                                    type="text" 
                                    id="tracking-input" 
                                    placeholder="Scan Tracking ID..." 
                                    autocomplete="off"
                                >
                            </div>
                            <button id="scan-btn" class="btn btn-primary">Scan Package</button>
                            <button id="bulk-scan-btn" class="btn btn-secondary">Bulk Scan</button>
                            <button id="clear-all-btn" class="btn btn-outline-danger">Reset Session</button>
                        </div>
                    </div>

                    <div id="scan-result" class="scan-result"></div>
                    
                    <!-- Confidence & Warning Display -->
                    <div id="scan-confidence" class="scan-confidence" style="display: none;"></div>
                    <div id="scan-warning" class="scan-warning" style="display: none;"></div>

                    <div class="data-panel">
                        <div class="panel-header">
                            <h3>Scanned Inventory <span class="badge-count" id="scan-count">0</span></h3>
                            <div class="dsp-summary" id="dsp-summary"></div>
                        </div>
                        
                        <div class="table-responsive">
                            <table id="scanned-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Tracking ID</th>
                                        <th>DSP</th>
                                        <th>Route</th>
                                        <th>Time</th>
                                        <th class="text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="scanned-tbody"></tbody>
                            </table>
                        </div>

                        <div class="export-section">
                            <button id="export-scan-btn" class="btn btn-success icon-btn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                Export Scan Results
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="card fade-in" id="verification-section">
                <div class="card-header">
                    <div class="step-indicator">03</div>
                    <div class="header-text">
                        <h2>Sequencing Verification</h2>
                        <p class="info-text">Compare Scanned data against Search Result CSV.</p>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="upload-area small-upload">
                        <input type="file" id="csv-upload" accept=".csv" style="display: none;">
                        <button id="upload-btn" class="btn btn-secondary">Upload Search Result CSV</button>
                        <span id="file-name" class="file-label">No file selected</span>
                    </div>

                    <div id="verification-result"></div>

                    <div class="comparison-results" id="comparison-section" style="display: none;">
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="total-compared">0</div>
                                <div class="stat-label">Total Packages</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-value" id="matches-count">0</div>
                                <div class="stat-label">Matches</div>
                            </div>
                            <div class="stat-card error">
                                <div class="stat-value" id="mismatches-count">0</div>
                                <div class="stat-label">Mismatches</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-value" id="not-scanned-count">0</div>
                                <div class="stat-label">Not Scanned</div>
                            </div>
                        </div>

                        <div class="tabs-container">
                            <div class="tabs">
                                <button class="tab-btn active" data-tab="mismatches">Mismatches</button>
                                <button class="tab-btn" data-tab="matches">Matches</button>
                                <button class="tab-btn" data-tab="not-scanned">Not Scanned</button>
                            </div>

                            <div class="tab-content-wrapper">
                                <div id="mismatches-tab" class="tab-panel active">
                                    <div class="table-responsive">
                                        <table id="mismatches-table">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Tracking ID</th>
                                                    <th>Scanned DSP</th>
                                                    <th>System DSP</th>
                                                    <th>City</th>
                                                    <th>Postal</th>
                                                    <th>Sort Zone</th>
                                                </tr>
                                            </thead>
                                            <tbody id="mismatches-tbody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div id="matches-tab" class="tab-panel">
                                    <div class="table-responsive">
                                        <table id="matches-table">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Tracking ID</th>
                                                    <th>DSP</th>
                                                    <th>Route</th>
                                                    <th>City</th>
                                                    <th>Sort Zone</th>
                                                </tr>
                                            </thead>
                                            <tbody id="matches-tbody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div id="not-scanned-tab" class="tab-panel">
                                    <div class="table-responsive">
                                        <table id="not-scanned-table">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Tracking ID</th>
                                                    <th>System DSP</th>
                                                    <th>City</th>
                                                    <th>Postal</th>
                                                    <th>Sort Zone</th>
                                                </tr>
                                            </thead>
                                            <tbody id="not-scanned-tbody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="export-section">
                            <button id="export-comparison-btn" class="btn btn-success icon-btn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                Export Comparison Report
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Bulk Scan Modal -->
    <div id="bulk-scan-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Bulk Scan Tracking IDs</h2>
                <button class="modal-close" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="info-text">Paste tracking IDs below (one per line or comma/space separated):</p>
                <textarea 
                    id="bulk-tracking-input" 
                    placeholder="TBA123456789&#10;TBA987654321&#10;TBA456789123&#10;...or...&#10;TBA123456789, TBA987654321, TBA456789123"
                    rows="12"
                ></textarea>
                <div id="bulk-scan-status" class="bulk-scan-status"></div>
            </div>
            <div class="modal-footer">
                <button id="process-bulk-btn" class="btn btn-primary btn-lg">Process Bulk Scan</button>
                <button id="cancel-bulk-btn" class="btn btn-outline">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Polygon Error Report Modal -->
    <div id="polygon-error-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Report Polygon Issue</h2>
                <button class="modal-close" id="close-error-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="info-text">What's the issue with the uploaded polygons?</p>
                
                <div class="error-report-section">
                    <label class="form-label">Issue Type:</label>
                    <select id="error-type" class="form-select">
                        <option value="missing">Missing DSP</option>
                        <option value="incorrect">Incorrect Routes</option>
                        <option value="other">Other Issue</option>
                    </select>
                    
                    <label class="form-label" style="margin-top: 1rem;">Which DSP is affected?</label>
                    <input type="text" id="affected-dsp" class="form-input" placeholder="e.g., AMTP, ABFB, BBGH, NALG, MDTR">
                    
                    <label class="form-label" style="margin-top: 1rem;">Description:</label>
                    <textarea id="error-description" class="form-textarea" rows="4" placeholder="Describe the issue..."></textarea>
                    
                    <div style="margin-top: 1.5rem;">
                        <p class="info-text">Upload the correct JSON file for this DSP:</p>
                        <input type="file" id="correction-upload" accept=".json" style="display: none;">
                        <button id="correction-upload-btn" class="btn btn-secondary" style="margin-top: 0.5rem;">Upload Correction JSON</button>
                        <span id="correction-file-name" class="file-label">No file selected</span>
                    </div>
                </div>
                
                <div id="correction-status" class="correction-status"></div>
            </div>
            <div class="modal-footer">
                <button id="apply-correction-btn" class="btn btn-primary btn-lg">Apply Correction</button>
                <button id="cancel-error-btn" class="btn btn-outline">Cancel</button>
            </div>
        </div>
    </div>

    <script src="scripts.js"></script>
</body>
</html>
